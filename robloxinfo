local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Animation configurations
local TWEEN_INFO = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

-- Create the toggle button
local function createToggleButton()
    local button = Instance.new("ImageButton")
    button.Name = "ToggleButton"
    button.Size = UDim2.new(0, 50, 0, 50)
    button.Position = UDim2.new(0, 20, 0.5, -25)
    button.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    button.BorderSizePixel = 0
    button.AutoButtonColor = true -- Enable button color change on hover
    button.ZIndex = 10 -- Ensure button stays on top

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(1, 0)
    corner.Parent = button

    local icon = Instance.new("ImageLabel")
    icon.Name = "Icon"
    icon.Size = UDim2.new(0.6, 0, 0.6, 0)
    icon.Position = UDim2.new(0.2, 0, 0.2, 0)
    icon.BackgroundTransparency = 1
    icon.Image = "rbxassetid://3926307971"
    icon.ImageRectOffset = Vector2.new(764, 244)
    icon.ImageRectSize = Vector2.new(36, 36)
    icon.ZIndex = 11
    icon.Parent = button

    return button
end

-- Create the GUI
local function createPlayerListGui()
    local gui = Instance.new("ScreenGui")
    gui.Name = "PlayerListGui"
    gui.ResetOnSpawn = false
    gui.DisplayOrder = 100 -- Ensure GUI stays on top
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0.4, 0, 0.7, 0)
    mainFrame.Position = UDim2.new(-0.4, 0, 0.15, 0)
    mainFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    mainFrame.BorderSizePixel = 0
    mainFrame.ZIndex = 1
    mainFrame.Parent = gui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.02, 0)
    corner.Parent = mainFrame

    -- Add shadow effect
    local shadow = Instance.new("ImageLabel")
    shadow.Name = "Shadow"
    shadow.Size = UDim2.new(1.02, 0, 1.02, 0)
    shadow.Position = UDim2.new(-0.01, 0, -0.01, 0)
    shadow.BackgroundTransparency = 1
    shadow.Image = "rbxassetid://1316045217"
    shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
    shadow.ImageTransparency = 0.5
    shadow.ZIndex = 0
    shadow.Parent = mainFrame

    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0.08, 0)
    titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    titleBar.BorderSizePixel = 0
    titleBar.ZIndex = 2
    titleBar.Parent = mainFrame

    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0.2, 0)
    titleCorner.Parent = titleBar

    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(0.9, 0, 1, 0)
    title.Position = UDim2.new(0.05, 0, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "Player Information"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextSize = 18
    title.Font = Enum.Font.GothamBold
    title.ZIndex = 3
    title.Parent = titleBar

    local closeButton = Instance.new("ImageButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0.05, 0, 0.8, 0)
    closeButton.Position = UDim2.new(0.93, 0, 0.1, 0)
    closeButton.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
    closeButton.Image = "rbxassetid://3926305904"
    closeButton.ImageRectOffset = Vector2.new(284, 4)
    closeButton.ImageRectSize = Vector2.new(24, 24)
    closeButton.ImageColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.ZIndex = 3
    closeButton.Parent = titleBar

    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0.2, 0)
    closeCorner.Parent = closeButton

    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Name = "PlayerList"
    scrollFrame.Size = UDim2.new(0.95, 0, 0.9, 0)
    scrollFrame.Position = UDim2.new(0.025, 0, 0.09, 0)
    scrollFrame.BackgroundTransparency = 0.9
    scrollFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 4
    scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255)
    scrollFrame.ZIndex = 2
    scrollFrame.Parent = mainFrame

    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 8)
    listLayout.Parent = scrollFrame

    -- Auto-size the scroll frame content
    listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
    end)

    local padding = Instance.new("UIPadding")
    padding.PaddingTop = UDim.new(0, 5)
    padding.PaddingBottom = UDim.new(0, 5)
    padding.Parent = scrollFrame

    return gui, scrollFrame, closeButton, mainFrame
end

-- Create player info frame
local function createPlayerInfoFrame(player, scrollFrame)
    local frame = Instance.new("Frame")
    frame.Name = player.Name .. "Info"
    frame.Size = UDim2.new(0.98, 0, 0, 120)
    frame.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    frame.BorderSizePixel = 0
    frame.ZIndex = 2
    frame.Parent = scrollFrame

    -- Add hover effect
    local hover = false
    frame.MouseEnter:Connect(function()
        hover = true
        TweenService:Create(frame, TWEEN_INFO, {
            BackgroundColor3 = Color3.fromRGB(80, 80, 80)
        }):Play()
    end)

    frame.MouseLeave:Connect(function()
        hover = false
        TweenService:Create(frame, TWEEN_INFO, {
            BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        }):Play()
    end)

    -- Add rounded corners
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.1, 0)
    corner.Parent = frame

    -- Player info
    local function createInfoLabel(text, yPos)
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.9, 0, 0.2, 0)
        label.Position = UDim2.new(0.05, 0, yPos, 0)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Color3.fromRGB(200, 200, 200)
        label.TextSize = 14
        label.Font = Enum.Font.Gotham
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.ZIndex = 3
        label.Parent = frame
        return label
    end

    -- Update player info
    local function updateInfo()
        local success, result = pcall(function()
            local accountAge = player.AccountAge
            local displayName = player.DisplayName
            local userId = player.UserId
            local membershipType = player.MembershipType
            
            createInfoLabel(player.Name, 0).Font = Enum.Font.GothamBold
            createInfoLabel("Account Age: " .. accountAge .. " days", 0.25)
            createInfoLabel("Display Name: " .. displayName, 0.5)
            createInfoLabel("User ID: " .. userId, 0.75)
        end)

        if not success then
            warn("Error updating player info for " .. player.Name .. ": " .. tostring(result))
        end
    end

    updateInfo()
    
    -- Click to copy info
    local clickDebounce = false
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            if not clickDebounce then
                clickDebounce = true
                local success, result = pcall(function()
                    setclipboard(string.format(
                        "Name: %s\nDisplay Name: %s\nAccount Age: %d days\nUser ID: %d",
                        player.Name,
                        player.DisplayName,
                        player.AccountAge,
                        player.UserId
                    ))
                end)
                wait(0.5) -- Debounce time
                clickDebounce = false
            end
        end
    end)

    return frame
end

-- Main initialization function
local function initialize()
    -- Clean up existing GUI
    local existingGui = PlayerGui:FindFirstChild("PlayerListGui")
    if existingGui then
        existingGui:Destroy()
    end

    local button = createToggleButton()
    local gui, scrollFrame, closeButton, mainFrame = createPlayerListGui()
    
    -- Parent the GUI elements
    gui.Parent = PlayerGui
    button.Parent = gui

    -- Toggle functionality
    local function toggleGui(show)
        local targetPosition = show and UDim2.new(0.5, -mainFrame.Size.X.Offset / 2, 0.15, 0) or UDim2.new(-0.4, 0, 0.15, 0)
        TweenService:Create(mainFrame, TWEEN_INFO, {
            Position = targetPosition
        }):Play()
    end

    button.MouseButton1Click:Connect(function()
        toggleGui(mainFrame.Position.X.Scale < 0)
    end)

    closeButton.MouseButton1Click:Connect(function()
        toggleGui(false)
    end)

    -- Initialize player list
    for _, player in ipairs(Players:GetPlayers()) do
        createPlayerInfoFrame(player, scrollFrame)
    end

    -- Handle player joining/leaving
    Players.PlayerAdded:Connect(function(player)
        createPlayerInfoFrame(player, scrollFrame)
    end)

    Players.PlayerRemoving:Connect(function(player)
        local frame = scrollFrame:FindFirstChild(player.Name .. "Info")
        if frame then
            frame:Destroy()
        end
    end)

    -- Make GUI draggable
    local dragging = false
    local dragStart
    local startPos

    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
end

-- Start the GUI
initialize()