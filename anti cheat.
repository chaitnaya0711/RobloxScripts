local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Only run on client
if not RunService:IsClient() then 
    print("Script is not running on the client. Exiting.")
    return 
end

local player = Players.LocalPlayer
local exploitAttempts = 0
local maxAttempts = 3  -- Set a reasonable maximum number of attempts
print("Max exploit attempts set to:", maxAttempts)

-- Create a table to track processed objects to prevent duplicate checks
local processedObjects = {}
print("Initialized processedObjects table.")

-- Debounce system to prevent spam
local lastWarningTime = 0
local warningCooldown = 3 -- seconds
print("Warning cooldown set to:", warningCooldown)

-- Function to display warning to player
local function displayWarning()
    local currentTime = tick()
    print("Attempting to display warning...")
    if currentTime - lastWarningTime >= warningCooldown then
        lastWarningTime = currentTime
        warn("Warning: Suspicious activity detected! Further attempts will result in a kick.")
        print("Warning displayed to player.")
    else
        print("Warning not displayed due to cooldown.")
    end
end

-- Safe error handling wrapper
local function safeCall(func, ...)
    local success, result = pcall(func, ...)
    if not success then
        warn("Error in anti-exploit system:", result)
        print("Function call failed. Error:", result)
    end
    return success, result
end

-- Check for exploit attempts
local function checkForExploits()
    print("Checking for exploit attempts...")
    if exploitAttempts >= maxAttempts then 
        print("Maximum exploit attempts reached. No further checks.")
        return 
    end
    
    exploitAttempts = exploitAttempts + 1
    print("Incremented exploit attempts:", exploitAttempts)
    
    if exploitAttempts == 1 then
        displayWarning()
    elseif exploitAttempts >= maxAttempts then
        print("Maximum exploit attempts reached. Kicking player...")
        task.delay(0.1, function()
            safeCall(function()
                player:Kick("\nSuspicious activity detected.\nPlease rejoin if this was a mistake.")
            end)
        end)
    end
end

-- Validate instance
local function isValidInstance(obj)
    return typeof(obj) == "Instance" and obj.Parent ~= nil
end

-- Process individual object
local function processObject(obj)
    if not isValidInstance(obj) then return end
    
    local objId = tostring(obj:GetFullName())
    if processedObjects[objId] then 
        return -- Prevent processing the same object multiple times
    end
    
    processedObjects[objId] = true
    
    -- Check for suspicious scripts
    if (obj:IsA("Script") or obj:IsA("LocalScript")) then
        local success, env = pcall(function()
            return getfenv(obj)
        end)
        
        if success and env ~= getfenv() then
            checkForExploits()
        end
    end
end

-- Monitor character and its descendants
local function monitorCharacter(character)
    if not isValidInstance(character) or not character:IsA("Model") then 
        return 
    end
    
    -- Process existing objects
    for _, obj in ipairs(character:GetDescendants()) do
        safeCall(processObject, obj)
    end
    
    -- Monitor for new additions
    character.DescendantAdded:Connect(function(obj)
        safeCall(processObject, obj)
    end)
end

-- Clean up processed objects
local function cleanupProcessedObjects()
    table.clear(processedObjects)
end

-- Monitor player's character
player.CharacterAdded:Connect(function(character)
    cleanupProcessedObjects()
    safeCall(monitorCharacter, character)
    
    -- Monitor backpack
    if player:FindFirstChild("Backpack") then
        player.Backpack.ChildAdded:Connect(function(child)
            if child:IsA("Tool") then
                safeCall(processObject, child)
            end
        end)
    end
end)

-- Initial setup for existing character
if player.Character then
    safeCall(monitorCharacter, player.Character)
end

-- Periodic check using RunService
local lastCheck = 0
local checkInterval = 1 -- Check every second

RunService.Heartbeat:Connect(function()
    local currentTime = tick()
    if currentTime - lastCheck >= checkInterval then
        lastCheck = currentTime
        
        if isValidInstance(player.Character) then
            safeCall(monitorCharacter, player.Character)
        end
    end
end)
